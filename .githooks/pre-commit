#!/usr/bin/env bash
set -euo pipefail

# Skip: SKIP_GODOT_VALIDATE=1 git commit ...
if [ "${SKIP_GODOT_VALIDATE:-}" = "1" ]; then
	echo "[pre-commit] SKIP_GODOT_VALIDATE=1 set; skipping validation."
	exit 0
fi

if ! git rev-parse --git-dir >/dev/null 2>&1; then
	echo "[pre-commit] Not a git repository; skipping."
	exit 0
fi

CHANGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR || true)"
if [ -z "$CHANGED_FILES" ]; then
	exit 0
fi

# Only run when relevant files are staged.
if echo "$CHANGED_FILES" | grep -qE '\.(gd|tscn|tres|res|godot|cfg|gdshader|gdshaderinc|import)$' \
	|| echo "$CHANGED_FILES" | grep -qE '^(scripts/|addons/|test/|src/)' ; then
	echo "[pre-commit] Running ./scripts/validate.sh"
	./scripts/validate.sh
else
	echo "[pre-commit] No Godot-relevant changes staged; skipping ./scripts/validate.sh"
fi
